<!-- Generate Intersection Dynamic Map -->

<!DOCTYPE html>
<html>
<head>
    <title>intxn V2X Applications Demo</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        .tab {
            display: none;
        }
        .tab.active {
            display: block;
        }
        .tab-links {
            cursor: pointer;
            padding: 10px;
            background-color: #f1f1f1;
            display: inline-block;
        }
        .tab-links.active {
            background-color: #ccc;
        }
        /* #bsm {
            height: 640px;
            width: 640px;
        } */
        #sidebar {
            width: 200px;
            height: 90%;
            position: absolute;
            left: 0;
            color: white;
            background-color: #165391;
            overflow-y: auto;
            padding: 10px;
        }
        #vmapContent {
            margin-left: 220px; /* Adjust this value based on the width of your sidebar */
        } 
    </style>
    <script>
        const SERVER_URL = 'https://128.32.129.118'; // 'https://127.0.0.1'; 
        //// 'http://128.32.129.118';
        const SERVER_PORT = 5000;
        const SOCKET_PORT = 5000;

        // Connect to the WebSocket server
        const socket = io(`${SERVER_URL}:${SOCKET_PORT}`, { 
            secure: true,
            rejectUnauthorized: false
        });

        let mapsScript;
        let mapsScriptLoaded = false;
        let map;
        let vmap_notloaded = true;

        /*
        function loadConfig(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const config = JSON.parse(event.target.result);
                    SERVER_URL = config.server_url;
                    SERVER_PORT = config.server_port;
                    SOCKET_PORT = config.socket_port;
                    resolve();
                };
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }
        */

        // Load the Google Maps JavaScript API
        async function loadGoogleMapsAPI() {
            if (mapsScriptLoaded) {
                return Promise.resolve();
            }

            // Fetch the API key from the server
            const apiKeyResponse = await fetch(`${SERVER_URL}:${SERVER_PORT}/api/key`);
            const apiKeyData = await apiKeyResponse.json();
            const apiKey = apiKeyData.api_key;

            return new Promise((resolve, reject) => {
                mapsScript = document.createElement('script');
                mapsScript.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}`; 
                mapsScript.async = true;
                mapsScript.defer = true;
                mapsScript.onload = () => {
                    mapsScriptLoaded = true;
                    resolve();
                };
                mapsScript.onerror = reject;
                document.head.appendChild(mapsScript);
            });
        }

        function removeGoogleMapsAPI() {
            if (mapsScript) {
                document.head.removeChild(mapsScript);
                mapsScript = null;
                mapsScriptLoaded = false;
            }
        }

        async function bsmTraj() {
            try {
                // 
                // const configResponse = await fetch('http://128.32.129.118:5000/config/netconfig');
                // const configData = await configResponse.json();

                // Load the Google Maps API with the fetched API key
                await loadGoogleMapsAPI();

                // Fetch map center coordinates from the API
                const mapCenterResponse = await fetch(`${SERVER_URL}:${SERVER_PORT}/api/map_center`);
                const mapCenter = await mapCenterResponse.json();

                // Create the map
                map = new google.maps.Map(document.getElementById("bsmContent"), {
                    zoom: 19,
                    center: mapCenter,
                    mapTypeId: 'satellite'
                });

                // Fetch initial marker coordinates from the API
                const markersResponse = await fetch(`${SERVER_URL}:${SERVER_PORT}/api/markers`);
                const markers = await markersResponse.json();
                
                // Define the custom icon
                const icon = {
                    url: 'img/car-top.png', // Path to your local image
                    scaledSize: new google.maps.Size(20, 20), // Scale the image to desired size
                };
                
                const marker = new google.maps.Marker({
                    position: markers[0],
                    map: map,
                    title: "Vehicle User",
                    icon: icon
                });

                // // Connect to the WebSocket server
                // const socket = io(`${SERVER_URL}:${SOCKET_PORT}`);

                // Listen for marker updates
                socket.on('marker_update', (data) => {
                    const newPosition = new google.maps.LatLng(data.lat, data.lng);
                    marker.setPosition(newPosition);
                });
            } catch (error) {
                console.error('Error initializing map:', error);
            }
        }

        function socketOff() {
            socket.off('marker_update');
        }

        async function genIntxnList() {
            try {
                const site = 'HLWD'; // or 'ECR', depending on the desired site
                const response = await fetch(`${SERVER_URL}:${SERVER_PORT}/api/intxn_list?site=${site}`);
                const intxns = await response.json();
                if (vmap_notloaded) {
                    populateSidebar(intxns);
                }
                // set the tab notloaded flag to false
                vmap_notloaded = false;
             } catch (error) {
            console.error('Error fetching intersection list:', error);
            }
        }

        let lastListItem = null;
        let lastMarker = null;

        async function populateSidebar(intxns) {
            const intxnList = document.getElementById('intxnList');
            intxns.forEach(intxn => {
                const listItem = document.createElement('li');
                listItem.textContent = intxn.name;
                listItem.addEventListener('click', () => {
                    // set the map center to the selected intersection
                    map.setCenter(intxn.center);
                    map.setZoom(19);
                    
                    // Add intersection name text at the map center using Marker
                    if (lastMarker) {
                        lastMarker.setMap(null); // Remove the previous marker
                    }
                    const marker = new google.maps.Marker({
                        position: intxn.center,
                        map: map,
                        label: {
                            text: intxn.name,
                            color: 'white',
                            fontSize: '15px',
                            fontWeight: 'bold'
                        },
                        // icon: svgMarker
                        
                    });
                    lastMarker = marker;

                    // add lanes to the map
                    addLanes(intxn.name);

                    // change the text color back of the last selected item
                    if (lastListItem) {
                        lastListItem.style.color = 'white';
                    }
                    // change the text color of the selected item
                    listItem.style.color = 'red';
                    lastListItem = listItem;
                });
                intxnList.appendChild(listItem);
            });
        }

        const lineColor = {
            64: 'green',    // egress 
            128:'blue',    // ingress
            192: 'orange' // bi-directional
        };

        async function addLanes(selIntxnName) {
            try {
                // add lane lines
                const response = await fetch(`${SERVER_URL}:${SERVER_PORT}/api/intxn_lanes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: selIntxnName})
                });

                const laneLines = await response.json();
                laneLines.forEach(laneLine => {
                    const line = new google.maps.Polyline({
                        path: laneLine.points.map(coord => new google.maps.LatLng(coord.lat, coord.lng)),
                        geodesic: true,
                        strokeColor: lineColor[laneLine.dir] || 'red',
                        strokeOpacity: 0.8,
                        strokeWeight: 2
                    });
                    line.setMap(map);
                });
            } catch (error) {
                console.error('Error obtaining lanes:', error);
            }    

        }

        async function mapValidate() {
            try {
                // Load the Google Maps API with the fetched API key
                await loadGoogleMapsAPI();
                
                // Fetch map center coordinates from the API
                const mapCenterResponse = await fetch(`${SERVER_URL}:${SERVER_PORT}/api/map_center`);
                const mapCenter = await mapCenterResponse.json();
                
                // Create the map
                map = new google.maps.Map(document.getElementById("vmapContent"), {
                    zoom: 19,
                    center: mapCenter,
                    mapTypeId: 'satellite'
                });

                genIntxnList();
    
            } catch (error) {
                console.error('Error initializing map:', error);
            }
        }

        // Open the specified tab
        function openTab(event, tabName) {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            const tabLinks = document.querySelectorAll('.tab-links');
            tabLinks.forEach(link => link.classList.remove('active'));

            document.getElementById(tabName).classList.add('active');
            if (event) {
                event.currentTarget.classList.add('active');
            }

            // Call the appropriate function based on the tab name
            if (tabName === 'vmap') {
                socketOff();
                
                mapValidate();
            } else if (tabName === 'bsm') {
                bsmTraj();
            }  else {
                socketOff();
            }
        }

        // window.onload = bsmTraj;
        window.onload = function() {
            // load Google Maps JavaScript API
            // loadGoogleMapsAPI();

            openTab(null, 'bsm');
        }
    </script>
</head>
<body>
    <div>
        <span class="tab-links active" onclick="openTab(event, 'bsm')">BSM Trajectory</span>
        <span class="tab-links" onclick="openTab(event, 'vmap')">MAP validation</span>
        <span class="tab-links" onclick="openTab(event, 'support')">Support</span>
    </div>
    <div id="bsm" class="tab active">
        <div id="bsmContent" style="height: 600px; width: 80%;"></div>
    </div>
    <div id="vmap" class="tab">
        <div id="sidebar">
            <ul id="intxnList"></ul>
        </div>
        <div id="vmapContent" style="height: 640px; width: 640px;"></div>
    </div>
    <div id="support" class="tab">
        <a href="download/atcmtd_rsp_09_202411.tar.gz" download>Download Support File</a>
    </div>
</body>
</html>