<!-- Generate Intersection Dynamic Map -->

<!DOCTYPE html>
<html>
<head>
    <title>V2X Transit Signal Priority Demo</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="../js/common.js"></script>
    <style>
        .tab {
            display: none;
        }
        .tab.active {
            display: block;
        }
        .tab-links {
            cursor: pointer;
            padding: 10px;
            background-color: #f1f1f1;
            display: inline-block;
        }
        .tab-links.active {
            background-color: #ccc;
        }
        /* #bsm {
            height: 640px;
            width: 640px;
        } */
        #sidebar {
            width: 200px;
            height: 90%;
            position: absolute;
            left: 0;
            color: white;
            background-color: #165391;
            overflow-y: auto;
            padding: 10px;
        }
        #vmapContent {
            margin-left: 220px; /* Adjust this value based on the width of your sidebar */
        } 
    </style>
    <script>

        const socket = io(`ws://128.32.129.118:5000`, {
            path: "/ws/socket.io",
            transports: ['websocket'],
            reconnection: true,
            reconnectionAttempts: 5,
            reconnectionDelay: 1000
        });

        socket.on('connect', () => {
            console.log('Socket connected successfully');
        });

        socket.on('connect_error', (error) => {
            console.error('Socket connection error:', error);
        });

        socket.on('disconnect', () => {
            console.log('Socket disconnected');
        });

        async function bsmTraj() {
            try {
                // 
                // const configResponse = await fetch('http://128.32.129.118:5000/config/netconfig');
                // const configData = await configResponse.json();

                // Load the Google Maps API with the fetched API key
                await loadGoogleMapsAPI();

                // Fetch map center coordinates from the API
                // const mapCenterResponse = await fetch(`${cv2x._config.SVR_URL}:${cv2x._config.SVR_PORT}/api/map_center?site=HLWD`);
                // const mapCenter = await mapCenterResponse.json();

                // Create the map
                map = new google.maps.Map(document.getElementById("bsmContent"), {
                    zoom: 19,
                    center: {lat: 34.094408, lng: -118.330568},
                    mapTypeId: 'satellite'
                });

                // Fetch initial marker coordinates from the API
                const markersResponse = await fetch(`${cv2x._config.SVR_URL}:${cv2x._config.SVR_PORT}/api/markers`);
                const markers = await markersResponse.json();
                
                // Define the custom icon
                const icon = {
                    url: './img/car-top.png', // Path to your local image
                    scaledSize: new google.maps.Size(20, 20), // Scale the image to desired size
                };
                
                const marker = new google.maps.Marker({
                    position: markers,
                    map: map,
                    title: "Vehicle User",
                    icon: icon
                });

                // // Connect to the WebSocket server
                // const socket = io(`${SERVER_URL}:${SOCKET_PORT}`);

                // Listen for vehicle updates
                socket.on('veh_update', (data) => {
                   console.log(data) 
                   const newPosition = new google.maps.LatLng(data.lat, data.lng);
                   marker.setPosition(newPosition);
                });
            } catch (error) {
                console.error('Error initializing map:', error);
            }
        }

        
        // Open the specified tab
        async function openTab(event, tabName) {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            const tabLinks = document.querySelectorAll('.tab-links');
            tabLinks.forEach(link => link.classList.remove('active'));

            document.getElementById(tabName).classList.add('active');
            if (event) {
                event.currentTarget.classList.add('active');
            }

            // Call the appropriate function based on the tab name
            if (tabName === 'vmap') {
                socket.off('veh_update');

                await mapValidate('HLWD');
            } else if (tabName === 'bsm') {
                await bsmTraj();
            }  else {
                socket.off('veh_update');
            }
        }

        // window.onload = bsmTraj;
        window.onload = function() {
            // load Google Maps JavaScript API
            // loadGoogleMapsAPI();

            openTab(null, 'vmap');
        }
    </script>
</head>
<body>
    <div>
        <span class="tab-links active" onclick="openTab(event, 'bsm')">BSM Trajectory</span>
        <span class="tab-links" onclick="openTab(event, 'vmap')">MAP validation</span>
        <span class="tab-links" onclick="openTab(event, 'support')">Support</span>
    </div>
    <div id="bsm" class="tab active">
        <div id="bsmContent" style="height: 600px; width: 80%;"></div>
    </div>
    <div id="vmap" class="tab">
        <div id="sidebar">
            <ul id="intxnList"></ul>
        </div>
        <div id="vmapContent" style="height: 640px; width: 640px;"></div>
    </div>
    <div id="support" class="tab">
        <a href="download/atcmtd_rsp_09_202411.tar.gz" download>Download Support File</a>
    </div>
</body>
</html>